generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String?

  isDev     Boolean  @default(false) 
  
  createdAt DateTime @default(now())

  profile   PlayerProfile?
}

model PlayerProfile {
  id     Int  @id @default(autoincrement())

  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])

  food    Float @default(0)
  wood    Float @default(0)
  iron    Float @default(0)
  gold    Float @default(0)

  foodPerHour  Int @default(0)
  woodPerHour  Int @default(0)
  ironPerHour  Int @default(0)
  
  level        Int @default(1)
  experience   Int @default(0)

  lastUpdate      DateTime @default(now())
  lastRegenUpdate DateTime @default(now())

  buildings Building[]
  heroes    Hero[]
}

model Building {
  id        Int      @id @default(autoincrement())

  profileId Int
  profile   PlayerProfile @relation(fields: [profileId], references: [id])

  type      String

  level     Int @default(1)

  // Statut (ex: "ACTIVE", "UPGRADING", "CONSTRUCTING")
  status    String @default("ACTIVE")

  // Si en construction/upgrade
  constructionEndsAt DateTime?
}

model Hero {
  id        Int      @id @default(autoincrement())

  name      String
  type      String

  attack    Int
  defense   Int
  troops    Int
  maxTroops Int

  // Relation Profile (Devenue optionnelle pour les Monstres/Bots)
  profileId Int?
  profile   PlayerProfile? @relation(fields: [profileId], references: [id])

  // --- NOUVEAUX CHAMPS BATAILLE ---
  battleId  Int?
  battle    Battle? @relation(fields: [battleId], references: [id])

  side      String? // "ATTACKER" ou "DEFENDER"
  queueOrder Int?   // 0 = Combat actuel, 1 = Prochain dans la file, etc.

  level     Int      @default(1)
  experience Int     @default(0)

  createdAt DateTime @default(now())
}

// --- NOUVEAU MODÃˆLE ---
model Battle {
  id         Int      @id @default(autoincrement())
  
  status     String   @default("IN_PROGRESS") // "IN_PROGRESS", "FINISHED"
  
  createdAt  DateTime @default(now())
  lastUpdate DateTime @default(now()) // Date du dernier calcul de rounds

  // On stocke les logs sous forme de JSON pour le replay client
  // Ex: [{ round: 1, attacker: "Hero", damage: 10 }, ...]
  logs       Json[]   @default([]) 

  heroes     Hero[]
}